
import React, { useEffect, useRef } from 'react';
import { supabase } from '../services/supabase';
import { useNotifications } from '../contexts/NotificationContext';
import type { User, View } from '../types';

interface Props {
  user: User | null;
  setActiveView: (view: View) => void;
}

// Short 'Pop' notification sound
const NOTIFICATION_SOUND = 'data:audio/mpeg;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//tQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAjAAAXYgAFBwoNExcaHB8iJScqLC8xMzc6PD5BQkdJS01QUlVXWlxeYWNkZmhqbXFzdnl8foKDhoiLjY+Sk5WXmpydn6KkpqqtrixLd3ZyMnQzAAAAAExhdmM1Ny42NAAAAAAAAAAAAAAAAAIAOAAAAAAAAF2IAAAAHgAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+1BkAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAACWSCiYAAAAAEmkFEwAAAAAABAAAAEAAACABAAADgEAFGngZl8/g8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8Hg8H//hM0AAf/7UGQAAAAAAIAAAAAAAEAAAAAAAQAAAAAAgAAAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';

const GlobalMessageListener: React.FC<Props> = ({ user, setActiveView }) => {
  const { addNotification } = useNotifications();
  const audioRef = useRef<HTMLAudioElement | null>(null);

  useEffect(() => {
      audioRef.current = new Audio(NOTIFICATION_SOUND);
      audioRef.current.volume = 0.6;
  }, []);

  useEffect(() => {
    if (!user?.uid) return;

    // Listen for NEW messages where the current user is the RECEIVER
    const channel = supabase
      .channel('global_chats_listener')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'chats',
          filter: `receiver_id=eq.${user.uid}`
        },
        (payload) => {
           const newMessage = payload.new;
           
           // Play notification sound
           if (audioRef.current) {
               audioRef.current.currentTime = 0; // Reset sound
               const playPromise = audioRef.current.play();
               if (playPromise !== undefined) {
                   playPromise.catch(error => {
                       console.warn('Audio blocked by browser policy:', error);
                   });
               }
           }

           // Target the Profile Inbox now
           const targetView: View = 'PROFILE'; 

           addNotification({
             type: 'market',
             title: 'New Message',
             message: newMessage.message_text ? newMessage.message_text.substring(0, 50) + (newMessage.message_text.length > 50 ? '...' : '') : 'You received a new message',
             view: targetView
           });
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [user?.uid, addNotification]);

  return null; // Invisible component
};

export default GlobalMessageListener;
